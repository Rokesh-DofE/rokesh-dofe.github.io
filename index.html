<!Doctype html>
<html>

<head>
    <title>Rokesh DofE</title>
    <script type="text/javascript" src="javascripts/peer.js"></script>
    <script type="text/javascript" src="javascripts/jquery-3.1.0.min.js"></script>
    <script>
    var tempId = prompt("Please enter your ID (this is your username), leaving this blank will generate an ID", "");
// Showing off some of the configs available with PeerJS :).

var peer = new Peer(tempId, {
    key: 'byavgkbbr00pmn29',
    debug: 3,

    // Set a logging function:
    logFunction: function () {
        $('.log').append(Array.prototype.slice.call(arguments).join(' ') + '<br>');
    }
});
var connectedPeers = {};

// Show this peer's ID.
peer.on('open', function (id) {
    $('#pid').text(id);
});

// Await connections from others
peer.on('connection', connect);
peer.on('error', function (err) {
    console.log(err);
})

// Handle a connection object.
function connect(c) {
    // Handle a chat connection.
    if (c.label === 'chat') {
        var chatbox = $('<div></div>').addClass('connection').addClass('active').attr('id', c.peer);
        var header = $('<h1></h1>').html('Chat with <strong>' + c.peer + '</strong>');
        var messages = $('<div><em>Peer connected.</em></div>').addClass('messages');
        chatbox.append(header);
        chatbox.append(messages);
        chatbox.on('click', function () {
            if ($(this).hasClass('active')) {
                $(this).removeClass('active');
            } else {
                $(this).addClass('active');
            }
        });
        $('.filler').hide();
        chatbox.hide();
        $('#connections').append(chatbox);
        chatbox.slideDown(500);

        c.on('data', function (data) {
            messages.append('<div><span class="peer">Peer</span>: ' + data + '</div>');
        });
        c.on('close', function () {
            alert(c.peer + ' has left the chat.');
            chatbox.remove();
            if ($('.connection').length === 0) {
                $('.filler').show();
            }
            delete connectedPeers[c.peer];
        });
    } else if (c.label === 'file') {
        c.on('data', function (data) {
            // If we're getting a file, create a URL for it.
            console.log(data);
            if (data.constructor === ArrayBuffer) {
                var url = window.URL.createObjectURL(new Blob([new Uint8Array(data)]));
                $('#' + c.peer).find('.messages').append('<div><span class="file">' +
                    'Peer has sent you a file. <a target="_blank" href="' + url + '">View</a>. <a download href="' + url + '">Download</a>.</span></div>');
            }
        });
    }
    connectedPeers[c.peer] = 1;
}

$(document).ready(function () {
    // Prepare file drop box.
    var box = $('#box');
    box.on('dragenter', doNothing);
    box.on('dragover', doNothing);
    box.on('drop', function (e) {
        e.originalEvent.preventDefault();
        var file = e.originalEvent.dataTransfer.files[0];
        eachActiveConnection(function (c, $c) {
            if (c.label === 'file') {
                c.send(file);
                $c.find('.messages').append('<div><span class="file">You sent a file.</span></div>');
            }
        });
    });

    function doNothing(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Connect to a peer
    $('#connect').click(function () {
        var requestedPeer = $('#rid').val();
        if (!connectedPeers[requestedPeer]) {
            // Create 2 connections, one labelled chat and another labelled file.
            var c = peer.connect(requestedPeer, {
                label: 'chat',
                serialization: 'none'
            });
            c.on('open', function () {
                connect(c);
            });
            c.on('error', function (err) {
                alert(err);
            });
            var f = peer.connect(requestedPeer, {
                label: 'file',
                reliable: true
            });
            f.on('open', function () {
                connect(f);
            });
            f.on('error', function (err) {
                alert(err);
            });
        }
        connectedPeers[requestedPeer] = 1;
    });

    // Close a connection.
    $('#close').click(function () {
        eachActiveConnection(function (c) {
            c.close();
        });
    });

    // Send a chat message to all active connections.
    $('#send').submit(function (e) {
        e.preventDefault();
        var msg = $('#text').val();
        eachActiveConnection(function (c, $c) {
            if (c.label === 'chat') {
                c.send(msg);
                $c.find('.messages').append('<div><span class="you">You: </span>' + msg + '</div>');
            }
        });
        $('#text').val('');
        $('#text').focus();
    });

    // Goes through each active peer and calls FN on its connections.
    function eachActiveConnection(fn) {
        var actives = $('.active');
        var checkedIds = {};
        if (actives.length!=0) {
        actives.each(function () {
            var peerId = $(this).attr('id');
            if (!checkedIds[peerId]) {
                var conns = peer.connections[peerId];
                for (var i = 0; i < conns.length; i++) {
                    fn(conns[i], $(this));
                }
            }
            checkedIds[peerId] = 1;
        });
        } else {
            alert("There are no selected conections");
        }
    }
});

// Make sure things clean up properly.
window.onunload = window.onbeforeunload = function (e) {
    if (peer && !peer.destroyed) {
        peer.destroy();
    }
};
</script>
    <link type="text/css" rel="stylesheet" href="stylesheets/stylesheet1.css">
</head>

<body>
    <div id="actions">
        Your ID <span id="pid"></span>
        <br> Connect to a peer:
        <input type="text" id="rid" placeholder="Someone else's id"><input class="button" type="button" value="Connect" id="connect">
        <br>
        <br>
        <form id="send">
            <input type="text" id="text" placeholder="Enter message"><input class="button" type="submit" value="Send to selected peers">
        </form>
        <input class="button" type="button" id="close" value="Close selected connections">
    </div>
    <div id="wrap">
        <div id="connections"><span class="filler">You have not yet
        made any connections.</span></div>
        <div class="clear"></div>
    </div>
    <div id="box">
        Drag file here to send to selected connections.
    </div>
    <div class="warning browser">For up to date compatibility information see <a href="http://peerjs.com/status">PeerJS WebRTC
  Status</a>
        <br>Note that this demo may also fail if you are behind stringent firewalls or both you and the remote peer and behind symmetric NATs.

        <div class="log" style="color:#FF7500;text-shadow:none;padding:15px;background:#eee"><strong>Connection status</strong>:
            <br>
        </div>
    </div>
</body>

</html>
